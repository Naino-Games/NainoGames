<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flappy Nain - by Nawab Husnain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           CSS STYLING & UI ARCHITECTURE
           ========================================= */
        :root {
            --primary-color: #f39c12;
            --secondary-color: #27ae60;
            --accent-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-bg: #fdfdfd;
            --ui-font: 'Fredoka One', 'Nunito', sans-serif;
            --text-font: 'Nunito', sans-serif;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 10px 25px rgba(0,0,0,0.25);
            --shadow-hard: 0 6px 0 rgba(0,0,0,0.15);
        }

        /* PROFESSIONAL BLUE HIGHLIGHT FIX */
        * {
            -webkit-tap-highlight-color: transparent; /* Removes blue box on tap */
            -webkit-touch-callout: none;              /* Prevents callout menu */
            user-select: none;                        /* Prevents text selection */
            -webkit-user-select: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            background-color: #000;
            height: 100%;
            width: 100%;
            overflow: hidden; 
            font-family: var(--ui-font);
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: fixed;
            inset: 0;
        }

        /* --- PROFESSIONAL FULL SCREEN FIX --- */
        #game-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            z-index: 1;
        }

        /* Only apply the frame on very large desktop screens */
        @media (min-width: 1024px) and (min-height: 800px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: #2c3e50;
            }
            #game-wrapper {
                position: relative;
                width: 420px;
                height: 680px;
                border-radius: 24px;
                border: 4px solid #444;
                box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* --- UI LAYERS --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .hidden {
            opacity: 0 !important;
            transform: scale(0.95);
            pointer-events: none !important;
            visibility: hidden;
        }

        .interactive {
            pointer-events: auto;
            cursor: pointer;
        }

        /* --- TOP HUD --- */
        #hud-layer {
            justify-content: flex-start;
            padding-top: 0;
            z-index: 20;
        }

        .hud-btn {
            position: absolute;
            top: max(20px, env(safe-area-inset-top)); 
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            border-radius: 14px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto;
            z-index: 100;
        }

        .hud-btn:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.4);
        }

        .hud-btn svg {
            width: 22px;
            height: 22px;
            fill: white;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        #pause-btn { left: 20px; }
        #mute-btn { right: 20px; }
        
        #main-menu .hud-btn {
            position: relative;
            top: auto;
            left: auto;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            margin: 0 6px;
        }
        
        #main-menu-top {
            position: absolute;
            top: max(25px, env(safe-area-inset-top));
            right: 25px;
            left: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-big {
            font-size: 60px;
            color: white;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            margin-top: max(80px, calc(env(safe-area-inset-top) + 60px));
            transition: transform 0.1s;
        }

        .score-pulse { transform: scale(1.2); }

        /* --- BUTTONS --- */
        .btn-rect {
            background: var(--secondary-color);
            border: none;
            padding: 16px 0;
            font-size: 20px;
            color: white;
            border-radius: 16px;
            font-family: var(--ui-font);
            cursor: pointer;
            box-shadow: 0 5px 0 #1e8449, 0 10px 15px rgba(0,0,0,0.15);
            transition: transform 0.1s;
            margin-top: 15px;
            pointer-events: auto;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            z-index: 50;
            width: 80%; 
            max-width: 260px;
        }

        .btn-full {
            width: 100%;
            max-width: none;
            margin-top: 12px;
            font-size: 18px;
            padding: 14px 0;
            border-radius: 14px;
        }

        .btn-rect:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #1e8449, inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn-red { background: var(--accent-color); box-shadow: 0 5px 0 #c0392b, 0 10px 15px rgba(0,0,0,0.15); }
        .btn-red:active { box-shadow: 0 0 0 #c0392b; }
        
        .btn-blue { background: #3498db; box-shadow: 0 5px 0 #2980b9, 0 10px 15px rgba(0,0,0,0.15); }
        .btn-blue:active { box-shadow: 0 0 0 #2980b9; }

        /* --- MENU SYSTEM --- */
        .menu-bg {
            background: rgba(20, 30, 40, 0.85);
            backdrop-filter: blur(12px);
        }

        .logo-title {
            font-size: 60px;
            color: #fff;
            text-align: center;
            line-height: 0.95;
            text-shadow: 4px 4px 0 var(--primary-color), 8px 8px 0 #333;
            margin-bottom: 40px;
            animation: float 3s infinite ease-in-out;
            letter-spacing: 2px;
        }

        @keyframes float { 
            0% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-15px) scale(1.02); }
            100% { transform: translateY(0px) scale(1); }
        }

        .menu-card {
            background: var(--light-bg);
            width: 90%;
            max-width: 360px;
            padding: 25px;
            border-radius: 28px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 10px;
            color: var(--dark-color);
            box-sizing: border-box;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes popIn {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .card-header {
            font-size: 26px;
            color: var(--dark-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            position: relative;
            display: inline-block;
            align-self: center;
        }
        .card-header::after {
            content: '';
            display: block;
            width: 40px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            margin: 6px auto 0 auto;
        }

        /* --- SETTINGS UI --- */
        .settings-section {
            background: #f4f6f8;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 5px;
            text-align: left;
        }
        .settings-row { margin-bottom: 12px; }
        .settings-row:last-child { margin-bottom: 0; }
        .settings-label { display: flex; justify-content: space-between; font-size: 15px; color: #7f8c8d; font-family: var(--ui-font); margin-bottom: 6px; }
        .settings-value { color: var(--secondary-color); }
        
        .settings-note {
            font-family: var(--text-font);
            font-size: 14px;
            color: #95a5a6;
            margin-top: 5px;
            font-style: italic;
        }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 2px solid var(--secondary-color); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- INFO UI --- */
        .info-hero {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            margin: -25px -25px 20px -25px;
            padding: 45px 25px 25px 25px;
            color: white;
            border-radius: 0 0 50% 50% / 0 0 20px 20px;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        .info-title { font-size: 30px; line-height: 1; margin-bottom: 5px; }
        .info-ver { font-family: var(--text-font); font-size: 13px; opacity: 0.9; }
        .credit-list { font-family: var(--text-font); font-size: 15px; color: #576574; line-height: 1.6; }
        .credit-name { color: var(--dark-color); font-weight: 800; font-size: 17px; }

        .yt-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #e74c3c; color: white; text-decoration: none; padding: 14px;
            border-radius: 14px; font-family: var(--ui-font); font-size: 15px;
            transition: transform 0.1s; margin-top: 10px; box-shadow: 0 5px 0 #c0392b;
        }
        .yt-btn:active { transform: translateY(4px); box-shadow: none; }
        .yt-btn svg { width: 24px; fill: white; }

        /* --- CUSTOMIZATION --- */
        #customization-container { width: 95%; max-width: 380px; }
        .segmented-control { display: flex; width: 100%; background: #ecf0f1; border-radius: 14px; padding: 5px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .segmented-control button { flex: 1; padding: 10px 0; border: none; background: transparent; color: #95a5a6; font-family: var(--ui-font); font-size: 14px; border-radius: 10px; transition: all 0.2s; cursor: pointer; }
        .segmented-control button.active { background: #fff; color: var(--secondary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; width: 100%; padding: 5px; box-sizing: border-box; }
        .color-option { aspect-ratio: 1; border-radius: 50%; border: 3px solid #dfe6e9; cursor: pointer; position: relative; transition: transform 0.2s, border-color 0.2s; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .bg-theme-option { border-radius: 10px; }
        .color-option.selected { 
            border-color: var(--primary-color); 
            transform: scale(1.15); 
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.4), 0 3px 8px rgba(0,0,0,0.2);
            z-index: 5; 
        }

        /* --- LEADERBOARD --- */
        .leaderboard-list { list-style: none; padding: 0; margin: 0; width: 100%; font-family: var(--text-font); }
        .lb-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; margin-bottom: 8px; padding: 12px 15px; border-radius: 12px; border-left: 5px solid #bdc3c7; }
        .lb-item.top-1 { border-left-color: #f1c40f; background: linear-gradient(90deg, #fff, #fffdf5); }
        .lb-item.top-2 { border-left-color: #95a5a6; }
        .lb-item.top-3 { border-left-color: #d35400; }
        .lb-left { display: flex; align-items: center; gap: 10px; }
        .lb-rank { font-weight: 800; color: #7f8c8d; width: 20px; font-size: 16px; text-align: center; }
        .top-1 .lb-rank { color: #f1c40f; }
        .lb-name { font-weight: 700; color: #34495e; font-size: 16px; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lb-score { font-family: var(--ui-font); font-size: 20px; color: var(--dark-color); }

        /* --- GAME OVER --- */
        .game-over-header { font-size: 38px; color: var(--accent-color); margin-bottom: 15px; text-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        .result-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; gap: 15px; }
        .result-box { background: #f8f9fa; border-radius: 18px; padding: 15px 10px; flex: 1; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .res-label { font-size: 12px; text-transform: uppercase; color: #95a5a6; font-family: var(--ui-font); letter-spacing: 1px; }
        .res-val { font-size: 32px; color: var(--dark-color); line-height: 1.2; }
        .medal-box { width: 80px; height: 80px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.03); border-radius: 50%; }
        .medal-box svg { width: 80%; height: 80%; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        .new-badge { position: absolute; top: -10px; right: -5px; background: var(--accent-color); color: white; font-size: 11px; padding: 4px 8px; border-radius: 10px; font-family: var(--ui-font); animation: bounce 1s infinite; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #flash-overlay { background: white; transition: opacity 0.1s; opacity: 0; pointer-events: none; z-index: 99; }
        
        /* --- NAME INPUT MENU STYLING (PC STYLE) --- */
        #name-input-field {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            border-radius: 14px;
            border: 3px solid #dfe6e9;
            font-family: var(--ui-font);
            text-align: center;
            outline: none;
            background: #fdfdfd;
            color: var(--dark-color);
            box-sizing: border-box;
            transition: border-color 0.2s;
            text-transform: uppercase;
        }
        
        #name-input-field:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.1);
        }

        #name-input-field::placeholder {
            color: #bdc3c7;
        }
        
        /* --- TUTORIAL INSTRUCTION --- */
        #tutorial-layer {
            z-index: 15;
            flex-direction: column;
            gap: 15px;
        }
        .tutorial-hand {
            width: 60px;
            height: 60px;
            animation: tapAnim 1.5s infinite ease-in-out;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .tutorial-text {
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeIn 1s;
        }
        @keyframes tapAnim {
            0%, 100% { transform: translateY(10px) rotate(-10deg); opacity: 0.8; }
            50% { transform: translateY(-10px) rotate(-10deg); opacity: 1; }
        }

    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>
    
    <div id="flash-overlay" class="ui-layer hidden"></div>
    
    <div id="tutorial-layer" class="ui-layer hidden">
        <svg class="tutorial-hand" viewBox="0 0 24 24" fill="white">
            <path d="M9,11.24V7.5C9,6.12 10.12,5 11.5,5S14,6.12 14,7.5v3.74c1.21-0.81 2-2.18 2-3.74C16,5.01 13.99,3 11.5,3S7,5.01 7,7.5 c0,1.56 0.79,2.93 2,3.74z M17.28,15.32c0.35-0.1 0.73-0.13 1.09-0.08c1.33,0.19 2.27,1.41 2.09,2.74l-0.5,3.76 c-0.19,1.4-1.44,2.4-2.85,2.23l-5.69-0.69c-0.66-0.08-1.26-0.42-1.68-0.95L5,16.5l3.26-4.14c0.23-0.29 0.61-0.4 0.95-0.28l0.98,0.35 V7.5C10.19,6.78 10.79,6.25 11.5,6.25s1.31,0.53 1.31,1.25V12h1.49L17.28,15.32z"/>
        </svg>
        <div class="tutorial-text">Tap to Fly</div>
    </div>

    <div id="hud-layer" class="ui-layer hidden">
        <div id="score-display" class="score-big">0</div>
        
        <div id="pause-btn" class="hud-btn interactive">
            <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </div>
        
        <div id="mute-btn" class="hud-btn interactive">
            <svg id="vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </div>
    </div>

    <div id="main-menu" class="ui-layer menu-bg interactive">
        <div id="main-menu-top">
            <div id="leaderboard-btn" class="hud-btn interactive" title="Leaderboard">
                <svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
            </div>
            <div style="display: flex;">
                <div id="settings-btn" class="hud-btn interactive" title="Settings">
                    <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98 0-.34-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.5.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98 0 .33.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                </div>
                <div id="info-btn" class="hud-btn interactive" title="About">
                    <svg viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                </div>
            </div>
        </div>
        <div class="logo-title">FLAPPY<br>NAIN</div>
        <button id="play-btn" class="btn-rect">Play Now</button>
        <button id="skin-btn" class="btn-rect btn-blue" style="margin-top: 15px; padding: 14px 0;">Customize</button>
    </div>
    
    <div id="settings-menu" class="ui-layer menu-bg hidden interactive">
        <div id="settings-container" class="menu-card">
            <div class="card-header">Settings</div>
            <div class="settings-section">
                <div class="settings-row">
                    <div class="settings-label"><span>Master Volume</span><span id="volume-value" class="settings-value">100%</span></div>
                    <input type="range" min="0" max="100" value="100" id="volume-slider">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-row">
                    <div class="settings-label"><span>Game Speed</span><span id="speed-value" class="settings-value">1.0x</span></div>
                    <input type="range" min="5" max="20" value="10" id="speed-slider">
                </div>
            </div>
            <button id="reset-high-score-btn" class="btn-rect btn-red btn-full">Reset All Data</button>
            <button id="close-settings-btn" class="btn-rect btn-full" style="background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d;">Close</button>
        </div>
    </div>

    <div id="info-menu" class="ui-layer menu-bg hidden interactive">
        <div id="info-content" class="menu-card" style="padding: 0 25px 25px 25px; gap: 0;">
            <div class="info-hero">
                <div class="info-title">Flappy Nain</div>
                <div class="info-ver">v1.0</div>
            </div>
            <div class="credit-list">
                Created & Designed by<br>
                <span class="credit-name">Nawab Husnain</span>
                <br><br>
                A high-performance remake with unique<br>themes, skins, and leaderboards.
            </div>
            <a href="https://www.youtube.com/@Buntyzz" target="_blank" class="yt-btn">
                <svg viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                Subscribe to BuntyZZ
            </a>
            <button id="close-info-btn" class="btn-rect btn-full" style="background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; margin-top: 15px;">Back</button>
        </div>
    </div>
    
    <div id="leaderboard-menu" class="ui-layer menu-bg hidden interactive">
        <div id="leaderboard-content" class="menu-card">
            <div class="card-header">Top 5 SCORES</div>
            <ul class="leaderboard-list" id="leaderboard-list"></ul>
            <button id="close-leaderboard-btn" class="btn-rect btn-full" style="background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d;">Close</button>
        </div>
    </div>

    <div id="name-input-menu" class="ui-layer menu-bg hidden interactive">
        <div class="menu-card">
            <div class="card-header" style="color: var(--secondary-color);">New Record!</div>
            <div class="settings-note" style="font-size: 16px; margin-bottom: 15px;">You made the top 5! Enter name:</div>
            <input type="text" id="name-input-field" maxlength="10" placeholder="Player" autocomplete="off">
            <button id="submit-name-btn" class="btn-rect btn-full">Save Score</button>
        </div>
    </div>
    
    <div id="confirm-reset-menu" class="ui-layer menu-bg hidden interactive">
        <div class="menu-card">
            <div class="card-header" style="color: var(--accent-color);">Confirmation</div>
            <div class="settings-note" style="font-size: 16px; margin-bottom: 20px; font-weight: 700; color: var(--dark-color); font-style: normal;">
                Are you sure you want to permanently delete ALL saved data (High Scores, Customizations, Settings)?
            </div>
            <button id="confirm-reset-yes-btn" class="btn-rect btn-red btn-full">Yes, Delete All Data</button>
            <button id="confirm-reset-no-btn" class="btn-rect btn-full" style="background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d;">No, Keep Data</button>
        </div>
    </div>

    <div id="color-menu" class="ui-layer menu-bg hidden interactive">
        <div id="customization-container" class="menu-card">
            <div class="card-header">Customize</div> 
            <div class="segmented-control">
                <button id="tab-bird" class="active">Bird</button>
                <button id="tab-pipe">Pipes</button>
                <button id="tab-theme">World</button>
            </div>
            <div id="bird-tab-content" class="tab-content active"><div class="color-grid" id="bird-color-grid-container"></div></div>
            <div id="pipe-tab-content" class="tab-content"><div class="color-grid" id="pipe-color-grid-container"></div></div>
            <div id="theme-tab-content" class="tab-content"><div class="color-grid" id="bg-theme-grid-container"></div></div>
            <button id="close-skin-btn" class="btn-rect btn-blue btn-full">Equip & Play</button>
        </div>
    </div>

    <div id="pause-menu" class="ui-layer menu-bg hidden interactive">
        <div class="menu-card">
            <div class="card-header" style="color: var(--accent-color);">Paused</div>
            <button id="resume-btn" class="btn-rect btn-full">Resume</button>
            <button id="quit-btn" class="btn-rect btn-red btn-full">Main Menu</button>
        </div>
    </div>

    <div id="game-over-menu" class="ui-layer menu-bg hidden interactive">
        <div class="menu-card">
            <div class="game-over-header">GAME OVER</div>
            <div class="medal-box" id="go-medal-display"></div>
            <div class="result-row">
                <div class="result-box">
                    <div class="res-label">Score</div>
                    <div class="res-val" id="final-score">0</div>
                </div>
                <div class="result-box">
                    <div id="new-badge" class="new-badge hidden">NEW!</div>
                    <div class="res-label">Best</div>
                    <div class="res-val" id="best-score">0</div>
                </div>
            </div>
            <button id="retry-btn" class="btn-rect btn-full" style="margin-top:0;">Try Again</button>
            <button id="home-btn" class="btn-rect btn-red btn-full">Main Menu</button>
        </div>
    </div>

</div>

<script>
function getDarkerShade(hex, percent) {
    let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
    let factor = 1 - percent;
    r = Math.floor(r * factor); g = Math.floor(g * factor); b = Math.floor(b * factor);
    return `#${Math.min(255, Math.max(0, r)).toString(16).padStart(2,'0')}${Math.min(255, Math.max(0, g)).toString(16).padStart(2,'0')}${Math.min(255, Math.max(0, b)).toString(16).padStart(2,'0')}`;
}
function bindButton(elementId, action) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const handler = (e) => {
        if(e.target.tagName !== 'A' && e.target.tagName !== 'INPUT') { 
            if (e.cancelable) e.preventDefault(); 
        }
        e.stopPropagation(); action(e);
    };
    el.addEventListener('touchstart', handler, { passive: false });
    el.addEventListener('mousedown', handler); 
}

class AudioController {
    constructor(game) {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.game = game; this.muted = false;
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.setValueAtTime(this.game.volume, this.ctx.currentTime);
        this.masterGain.connect(this.ctx.destination);
    }
    toggleMute() {
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.muted = !this.muted;
        this.masterGain.gain.setValueAtTime(this.muted ? 0 : this.game.volume, this.ctx.currentTime);
        return this.muted;
    }
    playTone(type, freq, duration, vol = 0.5, slideFreq = null) {
        if (this.ctx.state === 'suspended') this.ctx.resume();
        if (this.muted) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if (slideFreq) osc.frequency.exponentialRampToValueAtTime(slideFreq, this.ctx.currentTime + duration);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.masterGain);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    }
    sfxJump() { this.playTone('sine', 300, 0.15, 0.4, 600); }
    sfxScore() { this.playTone('square', 1000, 0.1, 0.1); setTimeout(() => this.playTone('square', 1500, 0.1, 0.1), 80); }
    sfxHit() { this.playTone('sawtooth', 150, 0.2, 0.3, 50); }
    sfxDie() { this.playTone('triangle', 100, 0.4, 0.4, 10); }
    sfxSwoosh() { this.playTone('sine', 600, 0.2, 0.1, 200); }
    sfxClick() { this.playTone('triangle', 800, 0.05, 0.1); }
}

class Particle {
    constructor(x, y, type, birdColor = '#f1c40f') {
        this.x = x; this.y = y; this.type = type;
        this.vx = (Math.random() - 0.5) * 4; this.vy = (Math.random() - 0.5) * 4;
        if(this.type === 'feather') this.vy -= 1; 
        this.life = 1.0; this.decay = Math.random() * 0.03 + 0.01; this.size = Math.random() * 4 + 2;
        this.birdColor = birdColor; this.color = this.getColor();
    }
    hexToRgbString(hex) {
        if(!hex) return 'rgb(255,255,255)';
        let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        return `rgb(${r}, ${g}, ${b})`;
    }
    getColor() {
        if(this.type === 'feather') return this.hexToRgbString(this.birdColor);
        if(this.type === 'dust') return `rgb(200, 200, 200)`;
        if(this.type === 'sparkle') return `rgb(${Math.floor(Math.random()*255)}, 255, ${Math.floor(Math.random()*255)})`;
        return 'rgb(255, 255, 255)';
    }
    update(factor) { 
        this.x += this.vx * factor; this.y += this.vy * factor; this.life -= this.decay * factor; this.vy += 0.1 * factor; 
        if (this.type === 'feather' || this.type === 'dust') { this.vx *= 0.99; this.vy *= 0.99; }
    }
    draw(ctx) {
        let alpha = Math.max(0, this.life).toFixed(2);
        let finalColor = this.color.replace('rgb', 'rgba').replace(')', `, ${alpha})`);
        ctx.fillStyle = finalColor; ctx.beginPath();
        if(this.type === 'sparkle') ctx.rect(this.x, this.y, this.size, this.size);
        else ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
        ctx.fill();
    }
}

class Bird {
    constructor(canvas) {
        this.canvas = canvas; this.colorBody = "#f1c40f"; this.colorAccent = "#f1c40f"; 
        this.baseGravity = 0.25; this.baseJump = -5.5; this.reset();
    }
    setColor(c1, c2) { this.colorBody = c1; this.colorAccent = c2; }
    reset() { 
        // Use logicHeight if available, else standard height
        const h = this.canvas.logicH || this.canvas.height;
        this.x = 80; this.y = h / 2; this.vy = 0; this.rotation = 0; this.radius = 14; 
    }
    flap(factor) { this.vy = this.baseJump * factor; }
    update(isPlaying, factor) { 
        const h = this.canvas.logicH || this.canvas.height;
        if (!isPlaying) { this.y = (h / 2) + Math.sin(Date.now() / 300) * 10; this.rotation = 0; return; }
        this.vy += this.baseGravity * factor; this.y += this.vy;
        if (this.vy < this.baseJump/2) this.rotation = -25 * Math.PI / 180;
        else { this.rotation += 4 * Math.PI / 180; if (this.rotation > 90 * Math.PI / 180) this.rotation = 90 * Math.PI / 180; }
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
        
        let grad;
        grad = ctx.createRadialGradient(-5, -5, 5, 0, 0, 15);
        grad.addColorStop(0, this.colorBody); 
        grad.addColorStop(1, this.colorAccent);

        ctx.fillStyle = grad; 
        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
        ctx.lineWidth = 2; ctx.strokeStyle = "#fff"; ctx.stroke();
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(6, -6, 7, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#000"; ctx.beginPath(); ctx.arc(8, -6, 2.5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(8, 2); ctx.lineTo(16, 6); ctx.lineTo(8, 10); ctx.fill();
        ctx.fillStyle = "#ecf0f1"; ctx.beginPath();
        let wingOffset = (Math.floor(Date.now() / 100) % 3) * 2;
        ctx.ellipse(-6, 2 - wingOffset, 8, 5, -0.2, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#bdc3c7"; ctx.stroke();
        ctx.restore();
    }
}

class Environment {
    constructor(canvas, initialTheme) {
        this.canvas = canvas; this.ctx = canvas.getContext('2d');
        this.groundHeight = 100; this.groundX = 0; this.clouds = []; this.setTheme(initialTheme); 
    }
    setTheme(theme) {
        this.theme = theme; this.clouds = [];
        if (theme.isStarry) this.initStars(); else this.initClouds();
    }
    initClouds() {
        // Use logical width if possible
        const w = this.canvas.logicW || this.canvas.width;
        for(let i=0; i<6; i++) {
            this.clouds.push({ x: Math.random() * w, y: Math.random() * 200 + 50, scale: Math.random() * 0.5 + 0.5, speed: Math.random() * 0.5 + 0.2, isStar: false });
        }
    }
    initStars() {
        const w = this.canvas.logicW || this.canvas.width;
        const h = this.canvas.logicH || this.canvas.height;
        for(let i=0; i<100; i++) {
            this.clouds.push({ x: Math.random() * w, y: Math.random() * (h - this.groundHeight), scale: Math.random() * 1 + 0.1, speed: Math.random() * 0.1 + 0.05, isStar: true });
        }
    }
    update(pipeDx) { 
        const w = this.canvas.logicW || this.canvas.width;
        const h = this.canvas.logicH || this.canvas.height;
        this.groundX -= pipeDx;
        if (this.groundX <= -8000) this.groundX += 8000;
        this.clouds.forEach(c => {
            c.x -= c.speed * (pipeDx/2.5); 
            if(c.x < -100) {
                c.x = w + 50;
                if (c.isStar) c.y = Math.random() * (h - this.groundHeight);
                else c.y = Math.random() * 200 + 50;
            }
        });
    }
    drawCloud(x, y, s) {
        const ctx = this.ctx; ctx.save(); ctx.translate(x, y); ctx.scale(s, s);
        ctx.fillStyle = this.theme.cloudColor;
        ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.arc(25, -10, 35, 0, Math.PI*2); ctx.arc(50, 0, 30, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }
    drawStar(x, y, s) { this.ctx.fillStyle = this.theme.sun; this.ctx.fillRect(x, y, s, s); }
    drawDistantLandscape() {
        const ctx = this.ctx; 
        const w = this.canvas.logicW || this.canvas.width;
        const h = this.canvas.logicH || this.canvas.height;
        const gY = h - this.groundHeight;
        ctx.save(); ctx.fillStyle = this.theme.city; 
        const bushWidth = 80; let offset = (this.groundX * 0.4 % bushWidth + bushWidth) % bushWidth;
        const count = Math.ceil(w / bushWidth) + 1;
        for(let i = -1; i < count; i++) {
            let x = offset + (i * bushWidth); const baseY = gY - 40; 
            ctx.beginPath(); ctx.moveTo(x, gY);
            ctx.arc(x + 15, baseY + 20, 18, Math.PI, Math.PI*2); ctx.arc(x + 40, baseY, 25, Math.PI, Math.PI*2); ctx.arc(x + 65, baseY + 10, 20, Math.PI, Math.PI*2);
            ctx.lineTo(x + bushWidth, gY); ctx.fill();
        }
        ctx.restore(); 
    }
    drawBackground() {
        const ctx = this.ctx; 
        const w = this.canvas.logicW || this.canvas.width; 
        const h = this.canvas.logicH || this.canvas.height;
        let skyGrad = ctx.createLinearGradient(0, 0, 0, h);
        skyGrad.addColorStop(0, this.theme.sky[0]); skyGrad.addColorStop(1, this.theme.sky[1]);
        ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, w, h);
        let sunRadius = this.theme.name === 'Night' || this.theme.name === 'Space' ? 20 : 25;
        let sunX = w - 80; let sunY = 80;
        if (this.theme.name === 'Night') { ctx.fillStyle = "rgba(255, 255, 255, 0.2)"; ctx.beginPath(); ctx.arc(sunX, sunY, sunRadius + 10, 0, Math.PI*2); ctx.fill(); } 
        else if (this.theme.name !== 'Space') { ctx.fillStyle = "rgba(255, 255, 220, 0.3)"; ctx.beginPath(); ctx.arc(sunX, sunY, sunRadius + 15, 0, Math.PI*2); ctx.fill(); }
        ctx.fillStyle = this.theme.sun; ctx.beginPath(); ctx.arc(sunX, sunY, sunRadius, 0, Math.PI*2); ctx.fill();
        this.clouds.forEach(c => { if (c.isStar) this.drawStar(c.x, c.y, c.scale * 2); else this.drawCloud(c.x, c.y, c.scale); });
        this.drawDistantLandscape();
    }
    
    drawGround() {
        const ctx = this.ctx; 
        const w = this.canvas.logicW || this.canvas.width;
        const h = this.canvas.logicH || this.canvas.height;
        const gY = h - this.groundHeight;

        ctx.fillStyle = this.theme.groundDirt;
        ctx.fillRect(0, gY, w, h - gY);

        ctx.strokeStyle = "rgba(0,0,0,0.15)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        const spacing = w / 4; 
        let offset = this.groundX % spacing;
        if (offset < 0) offset += spacing;

        for (let x = offset - spacing; x < w + spacing; x += spacing) {
            ctx.moveTo(x, gY + 20); 
            ctx.lineTo(x, h);
        }
        ctx.stroke();

        ctx.fillStyle = this.theme.groundGrass;
        ctx.fillRect(0, gY, w, 20);
        
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.fillRect(0, gY, w, 2);
    }
}

class PipeManager {
    constructor(canvas) {
        this.canvas = canvas; this.pipes = [];
        this.w = 60; this.gap = 145; // Slightly increased gap for fairness
        this.baseDx = 2.5; 
        this.c1 = "#2ecc71"; this.c2 = "#2ecc71";
        this.lastY = 0; // Track previous pipe height for fairer generation
    }
    setTheme(colorObj) { 
        this.c1 = colorObj.c1; 
        this.c2 = colorObj.c2; 
    }
    reset() { 
        this.pipes = []; 
        const w = this.canvas.logicW || this.canvas.width;
        const h = this.canvas.logicH || this.canvas.height;
        this.lastY = h / 2; // Start middle
        this.spawnPipe(w + 100); 
    }
    spawnPipe(x) {
        const h = this.canvas.logicH || this.canvas.height;
        // Logic to prevent impossible jumps:
        // Clamp the new Y relative to the last Y.
        // Max deviation allows player to climb/fall safely.
        const maxDeviation = 200; 
        
        let min = 60; 
        let max = h - 100 - this.gap - min;
        
        // Calculate range based on previous pipe
        let safeMin = Math.max(min, this.lastY - maxDeviation);
        let safeMax = Math.min(max, this.lastY + maxDeviation);
        
        // Safety fallback if calculation goes weird
        if(safeMin > safeMax) { safeMin = min; safeMax = max; }

        let y = Math.floor(Math.random() * (safeMax - safeMin + 1)) + safeMin;
        this.lastY = y;

        this.pipes.push({ x: x, y: y, passed: false });
    }
    update(bird, addScoreCb, hitCb, pipeDx) { 
        const w = this.canvas.logicW || this.canvas.width;
        // Spacing check: 230px distance between pipes to allow recovery
        if(this.pipes.length === 0 || w - this.pipes[this.pipes.length-1].x >= 230) this.spawnPipe(w);
        for(let i=0; i<this.pipes.length; i++) {
            let p = this.pipes[i]; p.x -= pipeDx; 
            let birdL = bird.x - bird.radius + 5; let birdR = bird.x + bird.radius - 5;
            let birdT = bird.y - bird.radius + 5; let birdB = bird.y + bird.radius - 5;
            if (birdR > p.x && birdL < p.x + this.w) { if (birdT < p.y || birdB > p.y + this.gap) hitCb(); }
            if(p.x + this.w < bird.x && !p.passed) { p.passed = true; addScoreCb(); }
            if(p.x + this.w < 0) { this.pipes.shift(); i--; }
        }
    }
    drawPipeSegment(ctx, x, y, h, capY, isBottom) {
        ctx.save();
        let grad = ctx.createLinearGradient(x, 0, x + this.w, 0);
        grad.addColorStop(0, this.c2);   
        grad.addColorStop(0.5, this.c1); 
        grad.addColorStop(1, this.c2);   
        
        ctx.fillStyle = grad; 
        ctx.strokeStyle = getDarkerShade(this.c2, 0.3); 
        ctx.lineWidth = 2;

        ctx.fillRect(x, y, this.w, h);
        
        ctx.beginPath();
        if (isBottom) { ctx.moveTo(x, y + h); ctx.lineTo(x, y); ctx.lineTo(x + this.w, y); ctx.lineTo(x + this.w, y + h); } 
        else { ctx.rect(x, y, this.w, h); }
        ctx.stroke();

        ctx.fillStyle = grad; 
        ctx.fillRect(x - 3, capY, this.w + 6, 25); 
        ctx.strokeRect(x - 3, capY, this.w + 6, 25);
        
        ctx.fillStyle = "rgba(255,255,255,0.2)"; 
        ctx.fillRect(x + 5, capY + 2, 6, 21);
        
        ctx.restore();
    }
    draw(ctx) {
        const h = this.canvas.logicH || this.canvas.height;
        for(let p of this.pipes) {
            let botHeight = h - 100 - (p.y + this.gap); 
            this.drawPipeSegment(ctx, p.x, 0, p.y, p.y - 25, false);
            this.drawPipeSegment(ctx, p.x, p.y + this.gap, botHeight, p.y + this.gap, true);
        }
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d', { preserveDrawingBuffer: false, alpha: false });
        this.gameSpeed = parseFloat(localStorage.getItem('flappyNainSpeed')) || 1.0;
        this.volume = parseFloat(localStorage.getItem('flappyNainVolume')) || 1.0;
        
        let storedLB = localStorage.getItem('flappyNainLeaderboard');
        try {
            this.leaderboard = JSON.parse(storedLB) || [];
            if(this.leaderboard.length > 0 && typeof this.leaderboard[0] === 'number') {
                this.leaderboard = this.leaderboard.map(score => ({ name: 'Player', score: score }));
                localStorage.setItem('flappyNainLeaderboard', JSON.stringify(this.leaderboard));
            }
        } catch(e) { this.leaderboard = []; }

        this.audio = new AudioController(this);
        this.particles = [];
        this.state = 'MENU'; this.score = 0; this.lastTime = 0; this.FRAME_DURATION = 1000 / 60; 
        this.isHolding = false; // For rapid jump logic
        this.holdFrame = 0;
        
        this.colors = [
            {c1: '#f1c40f', c2: getDarkerShade('#f1c40f', 0.15), name: 'Classic Yellow'}, 
            {c1: '#e74c3c', c2: getDarkerShade('#e74c3c', 0.15), name: 'Fire Red'},       
            {c1: '#3498db', c2: getDarkerShade('#3498db', 0.15), name: 'Bright Blue'},    
            {c1: '#9b59b6', c2: getDarkerShade('#9b59b6', 0.15), name: 'Amethyst'},       
            {c1: '#2ecc71', c2: getDarkerShade('#2ecc71', 0.15), name: 'Emerald'},        
            {c1: '#1abc9c', c2: getDarkerShade('#1abc9c', 0.15), name: 'Teal'},           
            {c1: '#34495e', c2: getDarkerShade('#34495e', 0.15), name: 'Dark Slate'},     
            {c1: '#ecf0f1', c2: getDarkerShade('#ecf0f1', 0.15), name: 'Ghost White'},    
            {c1: '#e67e22', c2: getDarkerShade('#e67e22', 0.15), name: 'Rust Orange'},    
            {c1: '#ff9f43', c2: getDarkerShade('#ff9f43', 0.15), name: 'Carrot'},         
            {c1: '#ff00cc', c2: '#333399', name: 'Pink/Indigo Gradient'},  
            {c1: '#00cec9', c2: '#00b894', name: 'Ocean Gradient'},        
            {c1: '#fdcb6e', c2: '#e17055', name: 'Peach Gradient'},        
            {c1: '#ffc312', c2: '#1e272e', name: 'Gold/Black Gradient'},   
            {c1: '#ff7675', c2: '#d63031', name: 'Salmon Gradient'},       
            {c1: '#ccff33', c2: '#000000', name: 'Lime/Black Gradient'},   
            {c1: '#00d2d3', c2: '#01a3a4', name: 'Seafoam Gradient'},      
            {c1: '#5f27cd', c2: '#341f97', name: 'Violet Gradient'},       
            {c1: '#ff9ff3', c2: '#f368e0', name: 'Bubblegum Gradient'},    
            {c1: '#54a0ff', c2: '#2e86de', name: 'Sky Gradient'}           
        ];
        
        this.backgroundThemes = [
            { name: 'Daylight', sky: ['#4facfe', '#00f2fe'], sun: '#f1c40f', city: '#a2d9ff', cloudColor: 'rgba(255, 255, 255, 0.9)', groundGrass: '#2ecc71', groundDirt: '#e67e22', isStarry: false },
            { name: 'Sunset Glow', sky: ['#662D8C', '#ED1E79'], sun: '#FFD700', city: '#4a1d63', cloudColor: 'rgba(255, 200, 220, 0.5)', groundGrass: '#D63031', groundDirt: '#2D3436', isStarry: false },
            { name: 'Midnight', sky: ['#000428', '#004e92'], sun: '#f5f6fa', city: '#000000', cloudColor: 'rgba(255, 255, 255, 0.1)', groundGrass: '#1e272e', groundDirt: '#0c0c0c', isStarry: true },
            { name: 'Pastel Dream', sky: ['#a18cd1', '#fbc2eb'], sun: '#fff', city: '#f3e5f5', cloudColor: 'rgba(255,255,255,0.8)', groundGrass: '#fd79a8', groundDirt: '#fab1a0', isStarry: false },
            { name: 'The Grid', sky: ['#000000', '#111111'], sun: '#00ff00', city: '#003300', cloudColor: 'rgba(0, 255, 0, 0.2)', groundGrass: '#00ff00', groundDirt: '#000000', isStarry: false },
            { name: 'Xenon', sky: ['#8E2DE2', '#4A00E0'], sun: '#00d2d3', city: '#2d3436', cloudColor: 'rgba(0,255,255,0.2)', groundGrass: '#0984e3', groundDirt: '#2d3436', isStarry: true },
            { name: 'Sahara', sky: ['#f12711', '#f5af19'], sun: '#fff', city: '#d35400', cloudColor: 'rgba(255,255,255,0.3)', groundGrass: '#e67e22', groundDirt: '#d35400', isStarry: false },
            { name: 'Frostbite', sky: ['#E6DADA', '#274046'], sun: '#a4b0be', city: '#57606f', cloudColor: 'rgba(255,255,255,0.6)', groundGrass: '#ced6e0', groundDirt: '#747d8c', isStarry: true },
            { name: 'Deep Woods', sky: ['#134E5E', '#71B280'], sun: '#ffeaa7', city: '#0e3a45', cloudColor: 'rgba(255,255,255,0.4)', groundGrass: '#00b894', groundDirt: '#006266', isStarry: false },
            { name: 'Inferno', sky: ['#232526', '#414345'], sun: '#ff0000', city: '#1a1a1a', cloudColor: 'rgba(255, 50, 50, 0.3)', groundGrass: '#c0392b', groundDirt: '#2d3436', isStarry: false },
            { name: 'Retro 80s', sky: ['#FF0099', '#493240'], sun: '#F5D300', city: '#2c041c', cloudColor: 'rgba(255,0,153,0.1)', groundGrass: '#00FFFF', groundDirt: '#2A002A', isStarry: true },
            { name: 'Abyss', sky: ['#000000', '#0f9b0f'], sun: '#000', city: '#000', cloudColor: 'rgba(0,0,0,0)', groundGrass: '#009432', groundDirt: '#000', isStarry: false },
            { name: 'Espresso', sky: ['#c94b4b', '#4b134f'], sun: '#ffcc99', city: '#3d1600', cloudColor: 'rgba(255,220,180,0.3)', groundGrass: '#8B4513', groundDirt: '#3E2723', isStarry: false },
            { name: 'Minty Fresh', sky: ['#00b09b', '#96c93d'], sun: '#f6e58d', city: '#43a047', cloudColor: 'rgba(255,255,255,0.8)', groundGrass: '#badc58', groundDirt: '#6ab04c', isStarry: false },
            { name: 'Royalty', sky: ['#141E30', '#243B55'], sun: '#FDC830', city: '#1e272e', cloudColor: 'rgba(253, 200, 48, 0.1)', groundGrass: '#F37335', groundDirt: '#2C3E50', isStarry: true },
            { name: 'Old Film', sky: ['#d7ccc8', '#8d6e63'], sun: '#efebe9', city: '#5d4037', cloudColor: 'rgba(100,80,70,0.2)', groundGrass: '#795548', groundDirt: '#4e342e', isStarry: false },
            { name: 'Cyber City', sky: ['#2980b9', '#2c3e50'], sun: '#e056fd', city: '#000', cloudColor: 'rgba(224, 86, 253, 0.2)', groundGrass: '#e056fd', groundDirt: '#130f40', isStarry: true },
            { name: 'Cotton Candy', sky: ['#FFDEE9', '#B5FFFC'], sun: '#fff', city: '#74b9ff', cloudColor: 'rgba(255,255,255,0.9)', groundGrass: '#ffcccc', groundDirt: '#dfe6e9', isStarry: false },
            { name: 'Blood Moon', sky: ['#000000', '#434343'], sun: '#c0392b', city: '#2d3436', cloudColor: 'rgba(192, 57, 43, 0.2)', groundGrass: '#7f8c8d', groundDirt: '#000000', isStarry: true },
            { name: 'Golden Hour', sky: ['#ffecd2', '#fcb69f'], sun: '#ff9ff3', city: '#ff9f43', cloudColor: 'rgba(255,255,255,0.6)', groundGrass: '#ff9f43', groundDirt: '#e15f41', isStarry: false },
        ];

        this.bird = new Bird(this.canvas);
        this.pipes = new PipeManager(this.canvas);

        let savedBC = JSON.parse(localStorage.getItem('flappyNainBirdColor'));
        if(savedBC) this.bird.setColor(savedBC.c1, savedBC.c2);
        
        let savedPC = JSON.parse(localStorage.getItem('flappyNainPipeColorObj'));
        if(!savedPC) {
            let oldColor = localStorage.getItem('flappyNainPipeColor');
            savedPC = this.colors.find(c => c.c1 === oldColor) || this.colors[4];
        }
        this.pipeColorObj = savedPC;
        this.pipes.setTheme(this.pipeColorObj);
        
        let savedBGName = localStorage.getItem('flappyNainBackground') || 'Daylight';
        this.currentTheme = this.backgroundThemes.find(t => t.name === savedBGName) || this.backgroundThemes[0];
        this.env = new Environment(this.canvas, this.currentTheme); 

        this.ui = {
            mainMenu: document.getElementById('main-menu'),
            pauseMenu: document.getElementById('pause-menu'),
            gameOverMenu: document.getElementById('game-over-menu'),
            colorMenu: document.getElementById('color-menu'),
            infoMenu: document.getElementById('info-menu'),
            settingsMenu: document.getElementById('settings-menu'), 
            leaderboardMenu: document.getElementById('leaderboard-menu'),
            leaderboardList: document.getElementById('leaderboard-list'),
            hud: document.getElementById('hud-layer'),
            scoreDisplay: document.getElementById('score-display'),
            flash: document.getElementById('flash-overlay'),
            finalScore: document.getElementById('final-score'),
            bestScore: document.getElementById('best-score'),
            goMedalDisplay: document.getElementById('go-medal-display'),
            newBadge: document.getElementById('new-badge'),
            volumeSlider: document.getElementById('volume-slider'),
            volumeValue: document.getElementById('volume-value'),
            speedSlider: document.getElementById('speed-slider'),
            speedValue: document.getElementById('speed-value'),
            muteIcon: document.getElementById('vol-icon'),
            nameInputMenu: document.getElementById('name-input-menu'),
            nameInputField: document.getElementById('name-input-field'), 
            submitNameBtn: document.getElementById('submit-name-btn'),
            tutorial: document.getElementById('tutorial-layer'),
            confirmResetMenu: document.getElementById('confirm-reset-menu'), // NEW UI ELEMENT
        };
        
        this.setupColorGrids();
        this.initCustomizationTabs(); 
        this.initListeners();
        this.updateSettingsUI(); 
        
        // --- Full Screen Handling ---
        this.scale = 1;
        window.addEventListener('resize', () => this.resize());
        this.resize();
    }
    
    resize() {
        // Force the canvas to match window inner dimensions for WebView fullness
        // This overrides wrapper constraints on small screens if wrapper CSS fails
        const w = window.innerWidth;
        const h = window.innerHeight;
        
        this.canvas.width = w;
        this.canvas.height = h;
        
        // Logic Scale: Game Width behaves like 420px.
        this.scale = this.canvas.width / 420;
        
        // Store logical dimensions for game entities to use
        this.canvas.logicW = 420;
        this.canvas.logicH = this.canvas.height / this.scale;
    }

    updateSettingsUI() {
        this.ui.volumeSlider.value = this.volume * 100;
        this.ui.volumeValue.innerText = Math.round(this.volume * 100) + '%';
        this.ui.speedSlider.value = this.gameSpeed * 10;
        this.ui.speedValue.innerText = this.gameSpeed.toFixed(1) + 'x';
    }

    updateLeaderboardUI() {
        this.ui.leaderboardList.innerHTML = '';
        let scores = this.leaderboard.length ? this.leaderboard : [{name: '-', score: 0}];
        for(let i=0; i < 5; i++) {
            if(i < scores.length) {
                let entry = scores[i];
                let rankClass = i === 0 ? 'top-1' : (i === 1 ? 'top-2' : (i === 2 ? 'top-3' : ''));
                let li = document.createElement('li');
                li.className = `lb-item ${rankClass}`;
                li.innerHTML = `
                    <div class="lb-left">
                        <span class="lb-rank">#${i+1}</span>
                        <span class="lb-name">${entry.name}</span>
                    </div>
                    <span class="lb-score">${entry.score}</span>
                `;
                this.ui.leaderboardList.appendChild(li);
            }
        }
    }
    
    initCustomizationTabs() {
        const tabs = [ { btnId: 'tab-bird', contentId: 'bird-tab-content' }, { btnId: 'tab-pipe', contentId: 'pipe-tab-content' }, { btnId: 'tab-theme', contentId: 'theme-tab-content' } ];
        tabs.forEach(tab => {
            const btn = document.getElementById(tab.btnId);
            if(btn) {
                const activateTab = (e) => {
                    e.stopPropagation(); this.audio.sfxClick();
                    tabs.forEach(t => { document.getElementById(t.btnId).classList.remove('active'); document.getElementById(t.contentId).classList.remove('active'); });
                    btn.classList.add('active'); document.getElementById(tab.contentId).classList.add('active');
                };
                bindButton(tab.btnId, activateTab);
            }
        });
    }

    setupColorGrids() {
        const createGrid = (id, items, type) => {
            const grid = document.getElementById(id);
            if(!grid) return; grid.innerHTML = '';
            items.forEach((item) => {
                let d = document.createElement('div');
                
                if(type === 'bird') {
                    d.className = 'color-option bird-color-option';
                    d.style.background = `radial-gradient(circle at 30% 30%, ${item.c1}, ${item.c2})`;
                    if(this.bird.colorBody === item.c1 && this.bird.colorAccent === item.c2) d.classList.add('selected');
                    d.onclick = (e) => { 
                        e.stopPropagation(); document.querySelectorAll('.bird-color-option').forEach(el => el.classList.remove('selected')); d.classList.add('selected'); 
                        this.bird.setColor(item.c1, item.c2); 
                        localStorage.setItem('flappyNainBirdColor', JSON.stringify(item)); 
                        this.audio.sfxClick(); 
                    };
                } else if(type === 'pipe') {
                    d.className = 'color-option pipe-color-option';
                    d.style.background = `radial-gradient(circle at 30% 30%, ${item.c1}, ${item.c2})`;

                    if(this.pipeColorObj.c1 === item.c1) d.classList.add('selected');
                    d.onclick = (e) => { 
                        e.stopPropagation(); document.querySelectorAll('.pipe-color-option').forEach(el => el.classList.remove('selected')); d.classList.add('selected'); 
                        this.pipeColorObj = item; 
                        this.pipes.setTheme(item); 
                        localStorage.setItem('flappyNainPipeColorObj', JSON.stringify(item)); 
                        this.audio.sfxClick(); 
                    };
                } else {
                    d.className = 'color-option bg-theme-option';
                    d.style.background = `linear-gradient(to bottom right, ${item.sky[0]}, ${item.sky[1]})`;
                    if(this.currentTheme.name === item.name) d.classList.add('selected');
                    d.onclick = (e) => { e.stopPropagation(); document.querySelectorAll('.bg-theme-option').forEach(el => el.classList.remove('selected')); d.classList.add('selected'); this.currentTheme = item; this.env.setTheme(item); localStorage.setItem('flappyNainBackground', item.name); this.audio.sfxClick(); };
                }
                d.ontouchstart = d.onclick; grid.appendChild(d);
            });
        };
        
        createGrid('bird-color-grid-container', this.colors, 'bird');
        createGrid('pipe-color-grid-container', this.colors, 'pipe');
        createGrid('bg-theme-grid-container', this.backgroundThemes, 'theme');
    }

    doFlap() {
        const factor = this.FRAME_DURATION / 1000 * 60 * this.gameSpeed; 
        this.bird.flap(factor); this.audio.sfxJump();
        this.spawnParticles(this.bird.x - 5, this.bird.y + 5, 'feather', 4, this.bird.colorBody);
    }

    initListeners() {
        const handleStart = (e) => {
            if (e.target.closest('.interactive')) return;
            if(e.type === 'touchstart') e.preventDefault(); 
            if (this.inputLocked) return;
            
            // Handle Tutorial Tap
            if (this.state === 'GET_READY') {
                this.state = 'PLAYING';
                this.ui.tutorial.classList.add('hidden');
                this.doFlap(); // Immediate first jump on tap
                this.isHolding = true;
                this.holdFrame = 0;
                return;
            }

            // Start holding logic
            this.isHolding = true;
            this.holdFrame = 0; // Reset counter so we jump immediately

            if (this.state === 'PLAYING') {
                this.doFlap(); // Immediate first jump
            }
        };

        const handleEnd = (e) => {
            this.isHolding = false;
        };

        window.addEventListener('mousedown', handleStart);
        window.addEventListener('touchstart', handleStart, {passive: false});
        
        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchend', handleEnd);

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                if (this.state === 'GET_READY') {
                     this.state = 'PLAYING';
                     this.ui.tutorial.classList.add('hidden');
                     this.doFlap();
                     return;
                }
                if(!this.isHolding) {
                    this.isHolding = true;
                    this.holdFrame = 0;
                    if (this.state === 'PLAYING') this.doFlap();
                }
            }
            if (e.code === 'Escape') this.togglePause();
        });
        window.addEventListener('keyup', (e) => {
            if(e.code === 'Space') this.isHolding = false;
        });

        bindButton('play-btn', () => this.startGame());
        bindButton('pause-btn', () => this.togglePause());
        bindButton('resume-btn', () => this.togglePause());
        bindButton('quit-btn', () => this.goHome());
        bindButton('retry-btn', () => this.startGame());
        bindButton('home-btn', () => this.goHome());
        
        bindButton('skin-btn', () => this.toggleMenu('colorMenu', true));
        bindButton('close-skin-btn', () => this.toggleMenu('colorMenu', false));
        bindButton('settings-btn', () => this.toggleMenu('settingsMenu', true)); 
        bindButton('close-settings-btn', () => this.toggleMenu('settingsMenu', false));
        bindButton('info-btn', () => this.toggleMenu('infoMenu', true));
        bindButton('close-info-btn', () => this.toggleMenu('infoMenu', false));
        bindButton('leaderboard-btn', () => this.toggleMenu('leaderboardMenu', true));
        bindButton('close-leaderboard-btn', () => this.toggleMenu('leaderboardMenu', false));
        
        // Custom confirmation dialog entry and exit
        bindButton('reset-high-score-btn', () => this.resetHighScore());
        bindButton('confirm-reset-yes-btn', () => this.performDataReset());
        bindButton('confirm-reset-no-btn', () => this.cancelDataReset());
        
        // Submit Name Button
        bindButton('submit-name-btn', () => this.submitHighScore());
        // Added keydown listener for the input field
        this.ui.nameInputField.addEventListener('keydown', (e) => {
            e.stopPropagation(); 
            if(e.key === 'Enter') this.submitHighScore();
        });

        bindButton('mute-btn', () => {
            let m = this.audio.toggleMute();
            const path = m 
                ? "M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
                : "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z";
            this.ui.muteIcon.querySelector('path').setAttribute('d', path);
            document.getElementById('mute-btn').style.opacity = m ? '0.7' : '1';
        });

        this.ui.volumeSlider.addEventListener('input', (e) => {
            this.volume = parseFloat(e.target.value) / 100;
            this.audio.masterGain.gain.setValueAtTime(this.volume, this.audio.ctx.currentTime);
            localStorage.setItem('flappyNainVolume', this.volume);
            this.ui.volumeValue.innerText = e.target.value + '%';
        });

        this.ui.speedSlider.addEventListener('input', (e) => {
            this.gameSpeed = parseFloat(e.target.value) / 10;
            localStorage.setItem('flappyNainSpeed', this.gameSpeed.toFixed(1));
            this.ui.speedValue.innerText = this.gameSpeed.toFixed(1) + 'x';
        });
    }
    
    toggleMenu(menuName, show) {
        const menuElement = this.ui[menuName];
        if (!menuElement) return;
        ['colorMenu', 'settingsMenu', 'infoMenu', 'leaderboardMenu', 'nameInputMenu', 'confirmResetMenu'].forEach(name => { if (name !== menuName) this.ui[name].classList.add('hidden'); });
        if (show) {
            this.ui.mainMenu.classList.add('hidden'); menuElement.classList.remove('hidden');
            if (menuName === 'settingsMenu') this.updateSettingsUI();
            if (menuName === 'leaderboardMenu') this.updateLeaderboardUI();
        } else {
            menuElement.classList.add('hidden'); this.ui.mainMenu.classList.remove('hidden');
        }
        this.audio.sfxClick();
    }
    
    showResetConfirm() {
        this.ui.settingsMenu.classList.add('hidden'); // Hide settings menu
        this.ui.confirmResetMenu.classList.remove('hidden'); // Show confirmation menu
        this.audio.sfxClick();
    }
    
    // Updated to use custom dialog
    resetHighScore() {
        this.showResetConfirm();
    }

    performDataReset() {
        this.leaderboard = []; 
        localStorage.setItem('flappyNainLeaderboard', JSON.stringify(this.leaderboard)); 
        localStorage.setItem('flappyNainHS', 0);
        
        // Also clear customization data
        localStorage.removeItem('flappyNainBirdColor');
        localStorage.removeItem('flappyNainPipeColorObj');
        localStorage.removeItem('flappyNainBackground');

        // Reset visual selections to defaults
        this.bird.setColor(this.colors[0].c1, this.colors[0].c2);
        this.pipeColorObj = this.colors[4];
        this.pipes.setTheme(this.pipeColorObj);
        this.currentTheme = this.backgroundThemes[0];
        this.env.setTheme(this.currentTheme);
        this.setupColorGrids(); // Re-render color grids to show defaults selected

        this.audio.sfxSwoosh(); 
        
        // Hide confirmation and go home (which shows main menu)
        this.ui.confirmResetMenu.classList.add('hidden');
        this.goHome();
    }
    
    cancelDataReset() {
        this.ui.confirmResetMenu.classList.add('hidden');
        this.ui.settingsMenu.classList.remove('hidden'); // Return to settings menu
        this.audio.sfxClick();
    }

    startGame() {
        if(this.state === 'PLAYING') return; 
        // NEW STATE: GET_READY
        this.state = 'GET_READY'; 
        this.score = 0; this.frames = 0;
        this.bird.reset(); this.pipes.reset(); 
        this.pipes.setTheme(this.pipeColorObj); 
        this.env.setTheme(this.currentTheme); this.particles = [];
        this.updateUI(); this.audio.sfxSwoosh();
        this.inputLocked = true; setTimeout(() => { this.inputLocked = false; }, 400); 
    }

    togglePause() {
        if (this.state === 'PLAYING') { this.state = 'PAUSED'; this.audio.sfxClick(); } 
        else if (this.state === 'PAUSED') { this.state = 'PLAYING'; this.audio.sfxClick(); }
        this.updateUI();
    }

    goHome() {
        this.state = 'MENU'; this.bird.reset(); this.updateUI(); this.audio.sfxSwoosh();
    }

    setGameOver() {
        if(this.state === 'DYING' || this.state === 'GAMEOVER' || this.state === 'INPUT_NAME') return;
        this.state = 'DYING'; 
        this.ui.flash.classList.remove('hidden'); this.ui.flash.style.opacity = '1';
        setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 50);
        setTimeout(() => { this.ui.flash.classList.add('hidden'); }, 300);
        this.audio.sfxHit(); setTimeout(() => this.audio.sfxDie(), 400);
        this.spawnParticles(this.bird.x, this.bird.y, 'feather', 20, this.bird.colorBody); 
        
        let lowestScore = this.leaderboard.length < 5 ? 0 : this.leaderboard[this.leaderboard.length - 1].score;
        this.pendingHighScore = (this.score > lowestScore);
    }
    
    // Called when the bird hits the ground and animation ends
    finalizeGameOver() {
        this.audio.sfxSwoosh(); // A sound effect for transition

        if (this.pendingHighScore) {
            this.state = 'INPUT_NAME'; // New State: Go straight to name input
            this.updateUI();
            this.ui.nameInputField.value = '';
            this.ui.nameInputField.focus();
        } else {
            this.state = 'GAMEOVER'; // If no high score, go to game over screen
            this.updateUI();
            this.showResults();
        }
    }

    submitHighScore() {
        let name = this.ui.nameInputField.value.trim() || "Player";
        name = name.substring(0, 10);
        
        this.leaderboard.push({ name: name, score: this.score });
        this.leaderboard.sort((a,b) => b.score - a.score);
        if(this.leaderboard.length > 5) this.leaderboard = this.leaderboard.slice(0,5);
        localStorage.setItem('flappyNainLeaderboard', JSON.stringify(this.leaderboard));
        
        this.state = 'GAMEOVER'; // Now transition to Game Over to show results
        this.updateUI();
        this.showResults(true); // pass true for new badge
    }

    showResults(isNew = false) {
        let medalPath = '<svg viewBox="0 0 24 24" fill="#bdc3c7"><circle cx="12" cy="12" r="10"/></svg>'; 
        if(this.score >= 10) medalPath = '<svg viewBox="0 0 24 24" fill="#e67e22"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>';
        if(this.score >= 20) medalPath = '<svg viewBox="0 0 24 24" fill="#bdc3c7"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>';
        if(this.score >= 40) medalPath = '<svg viewBox="0 0 24 24" fill="#f1c40f"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>';
        if(this.score >= 80) medalPath = '<svg viewBox="0 0 24 24" fill="#3498db"><path d="M18.3 4.2c.4 0 .7.3.7.7v2c0 .4-.3.7-.7.7h-2.6c.2-.4.4-.8.4-1.2 0-1.8-1.5-3.3-3.3-3.3s-3.3 1.5-3.3 3.3c0 .4.2.8.4 1.2H5.7c-.4 0-.7-.3-.7-.7v-2c0-.4.3-.7.7-.7h12.6zm-5.6 4.7c1.4 0 2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5-2.5-1.1-2.5-2.5 1.1-2.5 2.5-2.5zM3 13.9v3.4c0 1.2 1.3 2.5 3 2.5h12c1.7 0 3-1.3 3-2.5v-3.4H3zm16-4.5h-2.6c.5-.9.8-1.9.8-3.1 0-2.8-2.3-5.1-5.1-5.1S5.9 4.3 5.9 7.1c0 1.2.3 2.3.8 3.1H3c-.6 0-1 .4-1 1v7c0 1.7 1.4 3 3 3h14c1.6 0 3-1.3 3-3v-7c0-.6-.4-1-1-1z"/></svg>';

        this.ui.goMedalDisplay.innerHTML = medalPath;
        this.ui.finalScore.innerText = this.score;
        this.ui.bestScore.innerText = (this.leaderboard.length > 0) ? this.leaderboard[0].score : this.score;
        
        // Show particle effect if new high score
        if(isNew) this.spawnParticles(this.canvas.width/2, this.canvas.height/2, 'sparkle', 40);

        if(isNew && this.score > 0) this.ui.newBadge.classList.remove('hidden');
        else this.ui.newBadge.classList.add('hidden');
    }

    spawnParticles(x, y, type, count, color = '#f1c40f') {
        for(let i=0; i<count; i++) { this.particles.push(new Particle(x, y, type, color)); }
    }

    updateUI() {
        this.ui.mainMenu.classList.add('hidden');
        this.ui.pauseMenu.classList.add('hidden');
        this.ui.gameOverMenu.classList.add('hidden');
        this.ui.colorMenu.classList.add('hidden');
        this.ui.infoMenu.classList.add('hidden'); 
        this.ui.settingsMenu.classList.add('hidden'); 
        this.ui.leaderboardMenu.classList.add('hidden');
        this.ui.nameInputMenu.classList.add('hidden');
        this.ui.confirmResetMenu.classList.add('hidden'); // Ensure new menu is hidden
        this.ui.hud.classList.add('hidden');
        this.ui.tutorial.classList.add('hidden'); // Default hide tutorial

        if (this.state === 'MENU') { this.ui.mainMenu.classList.remove('hidden'); } 
        else if (this.state === 'GET_READY') {
            this.ui.hud.classList.remove('hidden');
            this.ui.tutorial.classList.remove('hidden'); // Show tutorial
            this.ui.scoreDisplay.innerText = this.score;
        }
        else if (this.state === 'PLAYING' || this.state === 'DYING') { 
            this.ui.hud.classList.remove('hidden');
            this.ui.scoreDisplay.innerText = this.score;
        } else if (this.state === 'PAUSED') {
            this.ui.hud.classList.remove('hidden');
            this.ui.pauseMenu.classList.remove('hidden');
        } else if (this.state === 'GAMEOVER') {
            this.ui.gameOverMenu.classList.remove('hidden');
        } else if (this.state === 'INPUT_NAME') { // New State
            this.ui.nameInputMenu.classList.remove('hidden');
        }
    }

    loop(currentTime) {
        if (!this.lastTime) { this.lastTime = currentTime; requestAnimationFrame((t) => this.loop(t)); return; }
        const dt = currentTime - this.lastTime; this.lastTime = currentTime;
        const timeFactor = dt / this.FRAME_DURATION; 
        const physicsFactor = timeFactor * this.gameSpeed; 
        const w = this.canvas.width; const h = this.canvas.height; const gY = h - 100;
        
        if (this.state !== 'PAUSED' && this.state !== 'INPUT_NAME' && this.ui.confirmResetMenu.classList.contains('hidden')) { // Stop updates during INPUT_NAME or Confirmation
            // Rapid Jump Logic
            if(this.state === 'PLAYING' && this.isHolding) {
                this.holdFrame++;
                // Flap every 10 frames (adjusted for smoothness)
                if(this.holdFrame > 10) {
                    this.doFlap();
                    this.holdFrame = 0;
                }
            }

            // Pipe Movement Logic
            const pipeSpeedFactor = (this.state === 'GAMEOVER' || this.state === 'DYING' || this.state === 'GET_READY') ? 0 : 1;
            const pipeDx = this.pipes.baseDx * pipeSpeedFactor * physicsFactor; 
            
            // Environment (Clouds) move even in GET_READY for visual flair
            this.env.update(pipeDx || (this.state === 'GET_READY' ? 1 * physicsFactor : 0)); 
            
            // Bird Update: 
            // In GET_READY, we pass 'false' for isPlaying so it hovers.
            // In PLAYING/DYING, we pass 'true' so physics apply.
            const isPhysicsActive = (this.state === 'PLAYING' || this.state === 'DYING');
            this.bird.update(isPhysicsActive, physicsFactor); 
            
            if (this.state === 'PLAYING') {
                this.pipes.update(
                    this.bird, 
                    () => { 
                        this.score++;
                        this.ui.scoreDisplay.innerText = this.score;
                        this.ui.scoreDisplay.classList.add('score-pulse');
                        setTimeout(()=>this.ui.scoreDisplay.classList.remove('score-pulse'), 100);
                        this.audio.sfxScore();
                    }, 
                    () => { this.setGameOver(); },
                    pipeDx 
                );
            }
            if (this.bird.y + this.bird.radius >= gY) {
                this.bird.y = gY - this.bird.radius;
                if(this.state === 'PLAYING') {
                    this.spawnParticles(this.bird.x, this.bird.y + 10, 'dust', 10);
                    this.setGameOver();
                } else if (this.state === 'DYING') {
                    this.spawnParticles(this.bird.x, this.bird.y + 10, 'dust', 10);
                    this.finalizeGameOver(); 
                }
            }
            
            for (let i=0; i<this.particles.length; i++) {
                this.particles[i].update(physicsFactor); 
                if(this.particles[i].life <= 0) { 
                    this.particles.splice(i, 1);
                    i--;
                }
            }
        } 

        this.ctx.clearRect(0, 0, w, h);
        this.env.drawBackground(); 
        this.particles.forEach(p => p.draw(this.ctx)); 
        this.pipes.draw(this.ctx);
        this.env.drawGround(); 
        this.bird.draw(this.ctx);
        
        requestAnimationFrame((t) => this.loop(t));
    }
}
window.onload = () => { const game = new Game(); requestAnimationFrame((t) => game.loop(t)); };
</script>
</body>
</html>
